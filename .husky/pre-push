#!/usr/bin/env sh

# Get the current branch name
BRANCH=$(git symbolic-ref --short HEAD)
# Get the remote tracking branch or default to origin/main
REMOTE_BRANCH=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "origin/main")

echo "ğŸ” Running checks on affected projects before pushing..."
echo "ğŸ“Š Comparing changes between $REMOTE_BRANCH and $BRANCH"

# Run tests on affected projects
echo "ğŸ§ª Running tests on affected projects..."
pnpm exec nx affected -t test --base=$REMOTE_BRANCH --head=$BRANCH
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -ne 0 ]; then
  echo "âŒ Tests failed. Push aborted."
  exit 1
fi

# Run build on affected projects
echo "ğŸ—ï¸ Building affected projects..."
pnpm exec nx affected -t build --base=$REMOTE_BRANCH --head=$BRANCH
BUILD_EXIT_CODE=$?

if [ $BUILD_EXIT_CODE -ne 0 ]; then
  echo "âŒ Build failed. Push aborted."
  exit 1
fi

echo "âœ… All checks passed! Pushing changes..."
exit 0